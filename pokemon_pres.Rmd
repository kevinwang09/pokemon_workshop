---
title: "Pokemons"
author: "Kevin Wang"
date: "9 June 2017"
output:
  ioslides_presentation:
    fig_height: 6
    fig_width: 6
    incremental: yes
    self_contained: yes
    widescreen: yes
always_allow_html: yes
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(comment=NA, warning=FALSE, message=FALSE)
library(tidyverse)

options(tibble.print_max = 10, tibble.print_min = 5)
```

<style>
slides > slide { overflow: scroll; }
slides > slide:not(.nobackground):after {
  content: '';
}
</style>

# S0: Prior to lecture

## Preparing for this lecture {.build}

+ All materials are on https://github.com/kevinwang09/pokemon_workshop.

+ Data was obtained from https://www.kaggle.com/alopez247/pokemon.

+ Please run these codes on your laptop prior to the lecture. 

```{r, eval = F}
install.packages("tidyverse") ## Might be a while...
install.packages("janitor")
```


# Reading in data

## Reading in data {.build}

+ Older way of reading data: `read.csv`, `read.delim`, ... 

+ Mordernised data reading: 

    - `readr`: `read_csv`, `read_delim`, better handling of variable types.
    - `readxl`: `read_excel`, better handling of JavaScripts.
    - `haven`: `read_sas()`, reading SPSS, Stata and SAS files from R 

```{r readingPokemon}
rawDat = read_csv("pokemon_alopez247.csv")
```


# Clean Coding

## Piping {.build}

+ The "inside out" structure of coding isn't great for human reading.

+ We introduce a new notation: " x %>% f " means "f(x)". We call this operation as "x pipe f".

+ We now read code from left to right.

+ Keyboard shortcut is Cmd+shift+M.

```{r piping}
rawDat %>% summary
## summary(rawDat)
```


# Clean data

## Basic variable cleaning using *janitor* {.build}

+ Clean up the bad column names.

```{r janitor}
library(janitor)
varCleanData = rawDat %>% clean_names
# varCleanData %>% View
```

+ There are also other cleaning functions and tabular functions. 

```{r janitor2}
tabyl(rawDat$Generation)
```



## Basic variable treatments using *dplyr* {.build}

+ `mutate` create new columns

```{r dplyr_mutate}
library(dplyr)
glimpse(varCleanData)

cleanData = varCleanData %>% 
  mutate(islegendary = as.logical(islegendary),
         hasgender = ifelse(hasgender == "True", TRUE, FALSE),
         hasmegaevolution = case_when(
           hasmegaevolution == "True" ~ TRUE,
           hasmegaevolution == "False" ~ FALSE),
         generation = as.factor(generation)
         )
```


+ `rename` change column names

```{r dplyr_rename}
library(dplyr)
glimpse(cleanData)

cleanData = cleanData %>% 
  dplyr::rename(
    special_attack = sp_atk,
    special_defense = sp_def,
    height = height_m,
    weight = weight_kg
  )

glimpse(cleanData)

write_csv(cleanData, path = "pokemon_cleanData.csv")
```




# `dplyr`: data manipulator

## *filter* is for row, *select* is for column  {.build}

```{r filter}
cleanData = read_csv("pokemon_cleanData.csv")

gen1Legends = cleanData %>% 
  filter(generation == 1,
         islegendary)

glimpse(gen1Legends)
```



```{r select}
basicStats = cleanData %>% 
  dplyr::select(name,
                hp:speed,
                contains("type"))
basicStats
```




## Summary statistics using *group_by* + *summarise* {.build}

```{r groupSummarise}
groupType1 = cleanData %>% 
  group_by(type_1)
  
groupType1

groupType1 %>% 
  dplyr::summarise(medianAttack = median(attack))
```


## Super selection using *select_if*  {.build}

```{r select_if}
intVarsOnly = cleanData %>% 
  select_if(.predicate = is.integer)

intVarsOnly
```

```{r select_if num}
numFunction = function(x){is.integer(x)|is.numeric(x)}

numVarsOnly = cleanData %>% 
  select_if(.predicate = numFunction) %>% 
  remove_missing()

numVarsOnly
```



# Time for some statistics

## Correlation

```{r d3heatmap}
library(d3heatmap)


d3heatmap(cor(numVarsOnly), 
          colors = c("blue", "white", "red"))

## Even better colours.
# goodColours = RColorBrewer::brewer.pal(n = 9, name = "Spectral") %>% rev
```


## Principal Component Analysis {.build}

+ PCA is a dimension reduction method. It "projects" a high dimensional data into a lower dimension subspace.

+ The projection is such that the new data: 

    - Preserves the data size ($n$ rows times $p$ columns).
    - Each column is **uncorrelated** to each other, but;
    - They are linear combination of the original columns.
    - The correlation structure of the original data is preserved.

+ In short, PCA is a very powerful technique that transform the data into a lower, more interpretable/visualisable dimension. 

+ We will PCA on the numerical data matrix. 


```{r pcaPlot}
pcaData = numVarsOnly %>% select(-number)
pcaObj = prcomp(pcaData, scale. = T)
ggbiplot::ggbiplot(pcaObj)

# ggbiplot::ggbiplot
```




# `ggplot2`: the best data visualisation package

## *ggplot* only allows plotting using `data.frame` {.build}

```{r ggplot_PCA}
pcaPlotdf = data.frame(numVarsOnly,
                       pcaObj$x[,1:2]) %>% 
  as.tibble

pcaPlotdf
```


## *ggplot* example {.build}

+ See tutorial sheet.

+ Every characteristic (e.g. axes, colour, size) of your graph is a column in a `data.frame`. i.e. you can't plot vector `x` in line 1 and vector `newx` in line 100. 

```{r ggplot_eg1}
ggplot(data = pcaPlotdf,
       aes(x = PC1, 
           y = PC2,
           colour = total)) + 
  geom_point()
```



```{r ggplot_eg2}
ggplot(data = pcaPlotdf,
       aes(x = PC1, 
           y = PC2,
           colour = total,
           size = weight
           )) +
  geom_point(alpha = 0.5) +
  theme_bw()
```



# Advanced topics

## data merging: *dplyr::left_join* {.build}

+ Data integration is very easy to mess up. 

+ `dplyr` offers several ways of doing this: `left_join`, `right_join`, `inner_join`, `full_join`, ... etc. 

```{r left_join}
visData = left_join(x = pcaPlotdf,
                    y = cleanData)

glimpse(visData)

ggplot(data = visData,
       aes(x = PC1, 
           y = PC2,
           size = total,
           colour = islegendary
           )) +
  geom_point(shape = 1, stroke = 1.2) +
  theme_bw()
```



## *ggplot2* extension packages {.build}

```{r pokemonPlotdf}
library(ggimage)
pokemonPlotdf = visData %>% 
  filter(generation == 1) %>% ## Higher generations are not supported. 
  mutate(image = ifelse(PC1 > 3 | PC2 < -3, tolower(name), NA))


pokemonPlotdf %>% 
  ggplot(aes(x = PC1, y = PC2)) + 
  geom_point(shape = 1) +
  geom_pokemon(aes(image = image)) +
  theme_bw()
```



# References

## References

```{r sessionInfo}
sessionInfo()
```


